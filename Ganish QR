<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø°ÙƒÙŠ - Ø¬Ù†Ø´</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; --success: #27ae60; --bg: #f4f7f6; --white: #ffffff; }
        
        /* Splash Screen */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; color: white; transition: opacity 0.5s ease; }
        .splash-logo { font-size: 80px; margin-bottom: 20px; }
        .splash-text { font-size: 24px; font-weight: bold; }
        .designer-tag { font-size: 18px; color: var(--accent); margin-top: 10px; border-top: 1px solid #ffffff44; padding-top: 10px; }
        
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; direction: rtl; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        .dashboard { text-align: center; padding: 40px 15px; }
        #clock { color: #7f8c8d; font-size: 14px; margin-bottom: 30px; font-weight: bold; }
        
        .main-buttons { display: grid; gap: 12px; max-width: 100%; margin: auto; }
        .menu-btn { padding: 20px; font-size: 18px; border: none; border-radius: 15px; cursor: pointer; background: var(--primary); color: white; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.3s; }
        .menu-btn:active { transform: scale(0.95); }
        .alert-btn { background: #d35400; }
        
        /* Modals */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); overflow-y: auto; }
        .modal-content { background: var(--white); margin: 0 auto; padding: 20px; width: 100%; min-height: 100%; box-sizing: border-box; position: relative; border-radius: 0; }
        .close { position: absolute; left: 15px; top: 15px; font-size: 35px; cursor: pointer; color: #e74c3c; z-index: 1010; font-weight: bold; }
        
        /* UI Components */
        .table-wrapper { max-height: 40vh; overflow-y: auto; border: 1px solid #ddd; margin-top: 15px; border-radius: 10px; background: white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px 10px; border-bottom: 1px solid #eee; text-align: right; font-size: 14px; }
        th { background: #f8f9fa; position: sticky; top: 0; color: var(--primary); }
        
        .del-btn { background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
        .count-link { color: var(--accent); font-weight: bold; background: #e1f5fe; padding: 6px 10px; border-radius: 6px; display: inline-block; cursor: pointer; }
        
        /* QR & Scanner */
        .qr-zone { display: flex; justify-content: center; padding: 10px; background: white; border-radius: 10px; margin-top: 10px; }
        #reader { width: 100%; background: black; border-radius: 15px; overflow: hidden; min-height: 250px; position: relative; }
        #scanStatus { padding: 15px; text-align: center; margin-top: 10px; font-weight: bold; border-radius: 10px; background: #eee; font-size: 14px; }
        .retry-btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 10px; margin-top: 10px; display: none; width: 100%; font-weight: bold; }
        
        input, select { -webkit-appearance: none; appearance: none; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo">â›ª</div>
        <div class="splash-text">Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø°ÙƒÙŠ</div>
        <div class="designer-tag">ØªØµÙ…ÙŠÙ… ÙˆÙ…Ø¨Ø±Ù…Ø¬ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: Ø¬Ù†Ø´</div>
    </div>

    <audio id="successSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div class="dashboard">
        <header>
            <h1>â›ª ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø°ÙƒÙŠ</h1>
            <p id="clock">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </header>
        <div class="main-buttons">
            <button class="menu-btn" onclick="openModal('addModal')">â• Ù…Ø®Ø¯ÙˆÙ… Ø¬Ø¯ÙŠØ¯</button>
            <button class="menu-btn" onclick="openModal('scanModal')">ğŸ“¸ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</button>
            <button class="menu-btn" onclick="openModal('reportModal')">ğŸ“Š Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ù…</button>
            <button class="menu-btn alert-btn" onclick="openModal('absentModal')">âš ï¸ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†</button>
        </div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addModal')">&times;</span>
            <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ø®Ø¯ÙˆÙ…</h2>
            <input type="text" id="mName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" style="width:100%; padding:15px; margin-bottom:10px; border-radius:10px; border:1px solid #ccc; box-sizing: border-box;">
            <input type="tel" id="mPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† (Ù„Ù„ÙƒÙˆØ¯)" style="width:100%; padding:15px; margin-bottom:10px; border-radius:10px; border:1px solid #ccc; box-sizing: border-box;">
            <button class="menu-btn" style="background:var(--success); width:100%" onclick="addNewMember()">Ø­ÙØ¸ ÙˆØ¥Ù†Ø´Ø§Ø¡ QR</button>
            <div id="qrcode" class="qr-zone"></div>
            <div class="table-wrapper"><table id="membersTable"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø­Ø°Ù</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="scanModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="stopScanner(); closeModal('scanModal')">&times;</span>
            <h2>ğŸ“¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ (QR)</h2>
            <input type="date" id="attendanceDate" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd;">
            
            <div id="reader"></div>
            
            <div id="scanStatus">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</div>
            <button id="retryBtn" class="retry-btn" onclick="startScanner()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
            
            <div style="background:#f9f9f9; padding:15px; border-radius:15px; margin-top:15px; border:1px solid #eee;">
                <p style="margin-top:0; font-weight:bold;">ØªØ­Ø¶ÙŠØ± ÙŠØ¯ÙˆÙŠ:</p>
                <input type="text" id="manualSearch" onkeyup="filterManualList()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd; box-sizing: border-box;">
                <select id="namesList" size="4" style="width:100%; padding:10px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd;"></select>
                <button class="menu-btn" style="background:var(--success); width:100%;" onclick="registerManual()">âœ… ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø®ØªØ§Ø±</button>
            </div>

            <h3>Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</h3>
            <div class="table-wrapper"><table id="todayTable"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø­Ø°Ù</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('reportModal')">&times;</span>
            <h2>ğŸ“Š Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ù…</h2>
            <input type="text" id="searchKey" onkeyup="searchGlobal()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..." style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd; box-sizing: border-box;">
            <div class="table-wrapper"><table id="attendanceTable"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th><th>Ø­Ø°Ù</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="historyModal" class="modal" style="z-index: 1100;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('historyModal')">&times;</span>
            <h2 id="historyOwnerName">Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</h2>
            <div class="table-wrapper"><table id="personDatesTable"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø­Ø°Ù</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="absentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('absentModal')">&times;</span>
            <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†</h2>
            <div style="background:#fef9e7; padding:15px; border-radius:10px; margin-bottom:10px; border:1px solid #f9e79f;">
                <label>Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„ÙØ­Øµ:</label>
                <input type="date" id="absentCheckDate" style="width:100%; padding:10px; margin-top:5px; border-radius:8px; border:1px solid #ddd;" onchange="renderAbsentList()">
            </div>
            <div class="table-wrapper"><table id="absentTable"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <script>
        let html5QrCode;
        let members = JSON.parse(localStorage.getItem('church_members')) || [];
        let attendance = JSON.parse(localStorage.getItem('attendance_data')) || [];
        
        const todayStr = new Date().toISOString().split('T')[0];
        document.getElementById('attendanceDate').value = todayStr;
        document.getElementById('absentCheckDate').value = todayStr;

        window.addEventListener('load', () => {
            setTimeout(() => { document.getElementById('splash-screen').style.opacity = '0'; 
            setTimeout(() => { document.getElementById('splash-screen').style.display = 'none'; }, 500);
            }, 2000);
        });

        function openModal(id) {
            document.getElementById(id).style.display = "block";
            if(id === 'addModal') renderMembersTable();
            if(id === 'scanModal') { 
                loadTodayTable(); 
                filterManualList(); 
                setTimeout(startScanner, 500); 
            }
            if(id === 'reportModal') renderAttendanceSummary(attendance);
            if(id === 'absentModal') renderAbsentList();
        }

        function closeModal(id) { document.getElementById(id).style.display = "none"; }

        // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø·ÙˆØ±Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ---
        async function startScanner() {
            const statusBox = document.getElementById('scanStatus');
            const retryBtn = document.getElementById('retryBtn');
            const readerDiv = document.getElementById("reader");
            
            statusBox.innerText = "Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...";
            statusBox.style.background = "#eee";
            retryBtn.style.display = "none";

            if (html5QrCode) { try { await html5QrCode.stop(); } catch(e){} }
            
            readerDiv.innerHTML = "";
            html5QrCode = new Html5Qrcode("reader");
            
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrCode.start(
                { facingMode: "environment" }, 
                config, 
                (decodedText) => processAttendance(decodedText)
            ).then(() => {
                statusBox.innerText = "âœ… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„.. ÙˆØ¬Ù‡Ù‡Ø§ Ù„Ù„ÙƒÙˆØ¯";
                statusBox.style.background = "#d4edda";
            }).catch(err => {
                statusBox.innerHTML = "âŒ ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§.<br><small>ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ HTTPS ÙˆØ¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø¥Ø°Ù†.</small>";
                statusBox.style.background = "#f8d7da";
                retryBtn.style.display = "block";
                
                // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø±ÙØ¹ Ù…Ù„Ù ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ…Ø§Ù…Ø§Ù‹
                statusBox.innerHTML += `<br><input type="file" id="qr-file" accept="image/*" style="margin-top:10px; width:100%">`;
                document.getElementById('qr-file').addEventListener('change', e => {
                    const file = e.target.files[0];
                    if(!file) return;
                    html5QrCode.scanFile(file, true)
                        .then(res => processAttendance(res))
                        .catch(e => alert("ÙƒÙˆØ¯ ØºÙŠØ± ÙˆØ§Ø¶Ø­ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"));
                });
            });
        }

        async function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                try { await html5QrCode.stop(); html5QrCode = null; } catch (err) {}
            }
        }

        function processAttendance(phoneCode) {
            const date = document.getElementById('attendanceDate').value;
            const person = members.find(m => m.phone === phoneCode);
            
            if(!person) {
                alert("Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹!");
                return;
            }

            if(attendance.some(a => a.phone === phoneCode && a.date === date)) {
                document.getElementById('scanStatus').innerText = "âš ï¸ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹: " + person.name;
                return;
            }

            attendance.push({ name: person.name, phone: person.phone, date: date });
            localStorage.setItem('attendance_data', JSON.stringify(attendance));
            
            try { document.getElementById('successSound').play(); } catch(e){}
            
            document.getElementById('scanStatus').innerText = "âœ… ØªÙ… Ø§Ù„ØªØ­Ø¶ÙŠØ±: " + person.name;
            loadTodayTable();
        }

        function renderAttendanceSummary(data) {
            const s = {};
            data.forEach(r => { 
                if(!s[r.phone]) s[r.phone] = { name: r.name, count: 0, phone: r.phone }; 
                s[r.phone].count++; 
            });
            
            const sortedRecords = Object.values(s).sort((a, b) => b.count - a.count);
            
            document.querySelector("#attendanceTable tbody").innerHTML = sortedRecords.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.phone}</td>
                    <td><span class="count-link" onclick="showHistory('${item.phone}')">${item.count} Ø£ÙŠØ§Ù…</span></td>
                    <td><button class="del-btn" onclick="deleteFullHistory('${item.phone}')">ğŸ—‘ï¸</button></td>
                </tr>
            `).join('');
        }

        function showHistory(p) {
            const person = members.find(m => m.phone === p);
            document.getElementById('historyOwnerName').innerText = person ? person.name : "Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®";
            document.querySelector("#personDatesTable tbody").innerHTML = attendance.filter(a => a.phone === p)
                .map(r => `<tr><td>${r.date}</td><td><button class="del-btn" onclick="deleteRecord('${p}','${r.date}')">ğŸ—‘ï¸</button></td></tr>`).join('');
            openModal('historyModal');
        }

        function deleteRecord(p, d) {
            if(confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…ØŸ")) {
                attendance = attendance.filter(a => !(a.phone === p && a.date === d));
                localStorage.setItem('attendance_data', JSON.stringify(attendance));
                loadTodayTable(); 
                renderAttendanceSummary(attendance); 
                if(document.getElementById('historyModal').style.display === "block") showHistory(p);
            }
        }

        function addNewMember() {
            const n = document.getElementById('mName').value.trim();
            const p = document.getElementById('mPhone').value.trim();
            if(n && p) {
                if(members.some(m => m.phone === p)) { alert("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ù„Ù…Ø®Ø¯ÙˆÙ… Ø¢Ø®Ø±!"); return; }
                members.push({ name: n, phone: p });
                localStorage.setItem('church_members', JSON.stringify(members));
                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById("qrcode"), { text: p, width: 150, height: 150 });
                renderMembersTable();
                document.getElementById('mName').value = ""; 
                document.getElementById('mPhone').value = "";
            } else { alert("Ø¨Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
        }

        function renderMembersTable() { 
            document.querySelector("#membersTable tbody").innerHTML = members.map((m, i) => `
                <tr>
                    <td>${m.name}</td>
                    <td><button class="del-btn" onclick="if(confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø®Ø¯ÙˆÙ… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')){members.splice(${i},1);localStorage.setItem('church_members',JSON.stringify(members));renderMembersTable();}">ğŸ—‘ï¸</button></td>
                </tr>
            `).join(''); 
        }

        function loadTodayTable() { 
            const d = document.getElementById('attendanceDate').value; 
            document.querySelector("#todayTable tbody").innerHTML = attendance.filter(a => a.date === d).map(a => `
                <tr>
                    <td>${a.name}</td>
                    <td><button class="del-btn" onclick="deleteRecord('${a.phone}','${a.date}')">ğŸ—‘ï¸</button></td>
                </tr>
            `).join(''); 
        }

        function filterManualList() { 
            const q = document.getElementById('manualSearch').value.toLowerCase(); 
            document.getElementById('namesList').innerHTML = members.filter(m => m.name.toLowerCase().includes(q)).map(m => `
                <option value="${m.phone}">${m.name}</option>
            `).join(''); 
        }

        function registerManual() { 
            const p = document.getElementById('namesList').value; 
            if(p) processAttendance(p); else alert("Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©");
        }

        function deleteFullHistory(p) { 
            if(confirm("Ø­Ø°Ù ÙƒÙ„ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®ØµØŸ")) { 
                attendance = attendance.filter(a => a.phone !== p); 
                localStorage.setItem('attendance_data', JSON.stringify(attendance)); 
                renderAttendanceSummary(attendance); 
            } 
        }

        function searchGlobal() { 
            const k = document.getElementById('searchKey').value.toLowerCase(); 
            const filtered = attendance.filter(a => a.name.toLowerCase().includes(k) || a.phone.includes(k));
            renderAttendanceSummary(filtered); 
        }

        function renderAbsentList() {
            const targetDate = document.getElementById('absentCheckDate').value;
            if(!targetDate) return;
            const presentPhones = attendance.filter(a => a.date === targetDate).map(a => a.phone);
            const absentList = members.filter(m => !presentPhones.includes(m.phone));
            document.querySelector("#absentTable tbody").innerHTML = absentList.map(m => `
                <tr><td>${m.name}</td><td>${m.phone}</td></tr>
            `).join('');
            if(absentList.length === 0) {
                document.querySelector("#absentTable tbody").innerHTML = "<tr><td colspan='2' style='text-align:center;'>Ø§Ù„ÙƒÙ„ Ø­Ø¶Ø± Ø§Ù„ÙŠÙˆÙ… âœ…</td></tr>";
            }
        }

        // Ø§Ù„Ø³Ø§Ø¹Ø©
        setInterval(() => { 
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('clock').innerText = new Date().toLocaleString('ar-EG', options); 
        }, 1000);
    </script>
</body>
</html>
